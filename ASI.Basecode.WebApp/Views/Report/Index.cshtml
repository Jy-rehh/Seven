@section styles {
    <link rel="stylesheet" href="~/css/dashboard.css" />
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

}
@model ASI.Basecode.Services.ServiceModels.ExpenseDataModel

@{
    ViewData["Title"] = "Report";
}
<body>

    <div class="report-header">
        <h1 style="margin-top: 20px;">MY EXPENSE SUMMARY</h1>
    </div>

    <div class="report-header2" style="gap: 10px;">
        <select class="header-btn" data-toggle="modal" data-target="#reportModal" style="border-radius: 20px; font-weight: bold; width: 130px;">
            <option value="" enable selected>Report</option>
            @if (Model.CategoryViewModel != null && Model.CategoryViewModel.Any())
            {
                foreach (var category in Model.CategoryViewModel)
                {
                    <option value="@category.CategoryId">@category.Name</option>
                }
            }
        </select>
        <button class="header-btn" data-toggle="modal" data-target="#previewModal" onclick="loadPreviewContent()" style="outline: none;">Preview</button>
        <input type="date" class="header-input" id="dateStart" placeholder="Date Start" style="margin-left: 30%; width:fit-content; outline: none;" />
        <input type="date" class="header-input" id="dateEnd" placeholder="Date End" style="width:fit-content; outline: none;" />
        <select class="header-btn dropdown-toggle" id="Filter" name="Filter" style="outline: none; width: 130px;">
            <option value="" enable selected>Filter</option>
            @if (Model.CategoryViewModel != null && Model.CategoryViewModel.Any())
            {
                foreach (var category in Model.CategoryViewModel)
                {
                    <option value="@category.CategoryId">@category.Name</option>
                }
            }
        </select>
        <select class="header-btn dropdown-toggle" id="Sort" name="Sort" style="outline: none; width: 130px;">
            <option value="" enable selected>Sort by</option>
            <option value="titleAsc">Title (A-Z)</option>
            <option value="titleDesc">Title (Z-A)</option>
            <option value="amountAsc">Amount (Low to High)</option>
            <option value="amountDesc">Amount (High to Low)</option>
            <option value="dateAsc">Date (Oldest First)</option>
            <option value="dateDesc">Date (Newest First)</option>
        </select>
    </div>
    <div class="main-content" style="margin-top: 0px; color: #000000; border-radius: 20px 20px 0px 0px; background-color: #FFFFFF;">
        <table class="table" id="reportTable">
            <thead>
                <tr style="background-color: #1A554F; color: #FFFFFF;">
                    <th>Name</th>
                    <th>Category</th>
                    <th>Amount</th>
                    <th>Expense Date</th>
                    <th>Description</th>
                </tr>
            </thead>
            <tbody class="data" style="background-color: #FFFFFF; color: #000000;">
                @foreach (var item in Model.ExpenseViewModel)
                {
                    <tr data-toggle="modal" data-target="#expenseDetailModal"
                        data-id="@item.ExpenseId" data-title="@item.Title"
                        data-category="@item.CategoryId" data-amount="@item.Amount"
                        data-date="@item.DateCreated" data-description="@item.Description"
                        class="expense-row">

                        <td>@item.Title</td>
                        <td>@item.CategoryName</td> <!-- Category Name based on CategoryId -->
                        <td>@item.Amount</td>
                        <td>@item.DateCreated</td>
                        <td>@item.Description</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- Modal Structure -->
    <div class="modal fade" id="previewModal" tabindex="-1" role="dialog" aria-labelledby="previewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="previewModalLabel">Expense Summary Preview</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="main-content-preview">
                        <!-- Content will be cloned here by JavaScript -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="generatePDF()" style="background-color: #1A554F; border-radius: 20px;">PDF</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div id="paginationControls" class="d-flex justify-content-end mt-3"></div>

    <!-- Include jsPDF and html2canvas Libraries -->
    @section Scripts {
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
        <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>

        <script>
            function loadPreviewContent() {
                const mainContent = document.querySelector('.main-content');
                const modalContent = document.querySelector('.main-content-preview');
                modalContent.innerHTML = '';
                modalContent.innerHTML = mainContent.innerHTML;
            }

            async function generatePDF() {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF();

                // Capture the content of the modal's body
                const content = document.querySelector('.main-content-preview');

                // Use html2canvas to convert the content to an image
                await html2canvas(content, {
                    scale: 2
                }).then((canvas) => {
                    const imgData = canvas.toDataURL('image/png');
                    const imgWidth = 190; // PDF width in mm
                    const pageHeight = pdf.internal.pageSize.height;
                    const imgHeight = canvas.height * imgWidth / canvas.width;

                    // Add the image to the PDF
                    pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);

                    // Add date and time to the footer
                    const currentDate = new Date();
                    const footerText = `Generated on: ${currentDate.toLocaleString()}`;
                    pdf.setFontSize(10);
                    pdf.text(footerText, 10, pageHeight - 10);

                    // Save the PDF
                    pdf.save('Expense Summary.pdf');
                });
            }
        </script>

        <script>
            $(document).ready(function () {
                const rowsPerPage = 7; // Number of rows per page
                const rows = $('#reportTable tbody tr'); // All rows in the table
                const totalRows = rows.length; // Total number of rows
                const totalPages = Math.ceil(totalRows / rowsPerPage); // Total pages

                // Function to display rows for a specific page
                function displayPage(page) {
                    rows.hide(); // Hide all rows
                    const start = (page - 1) * rowsPerPage; // Start index
                    const end = start + rowsPerPage; // End index
                    rows.slice(start, end).show(); // Show only the rows for the current page
                    updatePaginationButtons(page); // Update pagination buttons
                }

                // Function to generate and update pagination buttons
                function updatePaginationButtons(currentPage) {
                    const paginationContainer = $('.page-numbers'); // Ensure selector matches your pagination buttons container
                    paginationContainer.empty(); // Clear existing buttons

                    // Generate page buttons dynamically
                    for (let i = 1; i <= totalPages; i++) {
                        const activeClass = i === currentPage ? 'btn-green' : 'btn-rounded-outline-gray';
                        paginationContainer.append(
                            `<button class="btn ${activeClass}" onclick="displayPage(${i})">${i}</button>`
                        );
                    }

                    // Enable or disable Previous and Next buttons
                    $('.btn-rounded-outline-gray[data-action="prev"]').prop('disabled', currentPage === 1);
                    $('.btn-rounded-outline-gray[data-action="next"]').prop('disabled', currentPage === totalPages);
                }

                function loadPreviewContent() {
                    const mainContent = document.querySelector('.main-content');
                    const modalContent = document.querySelector('.main-content-preview');
                    modalContent.innerHTML = '';
                    modalContent.appendChild(mainContent.cloneNode(true)); // Deep clone
                }
                // Handle Previous button click
                $('.btn-rounded-outline-gray[data-action="prev"]').on('click', function () {
                    const currentPage = parseInt($('.btn-green').text(), 10);
                    if (currentPage > 1) {
                        displayPage(currentPage - 1);
                    }
                });

                // Handle Next button click
                $('.btn-rounded-outline-gray[data-action="next"]').on('click', function () {
                    const currentPage = parseInt($('.btn-green').text(), 10);
                    if (currentPage < totalPages) {
                        displayPage(currentPage + 1);
                    }
                });

                // Initialize the first page
                displayPage(1);
            });

            // Expose displayPage globally (needed for dynamically created buttons)
            window.displayPage = function (page) {
                const rowsPerPage = 4;
                const rows = $('#reportTable tbody tr');
                const totalRows = rows.length;
                const totalPages = Math.ceil(totalRows / rowsPerPage);

                rows.hide();
                const start = (page - 1) * rowsPerPage;
                const end = start + rowsPerPage;
                rows.slice(start, end).show();

                const paginationContainer = $('.page-numbers');
                paginationContainer.empty();

                for (let i = 1; i <= totalPages; i++) {
                    const activeClass = i === page ? 'btn-green' : 'btn-rounded-outline-gray';
                    paginationContainer.append(
                        `<button class="btn ${activeClass}" onclick="displayPage(${i})">${i}</button>`
                    );
                }
                if (rows.length === 0) {
                    console.warn("No rows available for pagination.");
                    return;
                }

                $('.btn-rounded-outline-gray[data-action="prev"]').prop('disabled', page === 1);
                $('.btn-rounded-outline-gray[data-action="next"]').prop('disabled', page === totalPages);
            };
        </script>

        //Filter & Sort
        <script>
            $(document).ready(function () {
                // Filter by Category
                $('#Filter').change(function () {
                    var selectedCategory = $(this).val();
                    $('#reportTable tbody tr').each(function () {
                        var categoryId = $(this).data('category');
                        if (selectedCategory === "" || categoryId == selectedCategory) {
                            $(this).show();
                        } else {
                            $(this).hide();
                        }
                    });
                });

                // Sort Table
                $('#Sort').change(function () {
                    var sortBy = $(this).val();
                    var rows = $('#reportTable tbody tr').get();

                    rows.sort(function (a, b) {
                        var valA, valB;

                        switch (sortBy) {
                            case 'titleAsc':
                                valA = $(a).data('title') || "";
                                valB = $(b).data('title') || "";
                                return valA.localeCompare(valB);
                            case 'titleDesc':
                                valA = $(a).data('title').toLowerCase();
                                valB = $(b).data('title').toLowerCase();
                                return valB.localeCompare(valA);
                            case 'amountAsc':
                                valA = parseFloat($(a).data('amount'));
                                valB = parseFloat($(b).data('amount'));
                                return valA - valB;
                            case 'amountDesc':
                                valA = parseFloat($(a).data('amount'));
                                valB = parseFloat($(b).data('amount'));
                                return valB - valA;
                            case 'dateAsc':
                                valA = new Date($(a).data('date'));
                                valB = new Date($(b).data('date'));
                                return valA - valB;
                            case 'dateDesc':
                                valA = new Date($(a).data('date'));
                                valB = new Date($(b).data('date'));
                                return valB - valA;
                            default:
                                return 0;
                        }
                    });

                    // Append sorted rows back to the table
                    $.each(rows, function (index, row) {
                        $('#expenseTable tbody').append(row);
                    });
                });
            });
        </script>
    }

</body>
