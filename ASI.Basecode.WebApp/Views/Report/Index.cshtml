@section styles {
    <link rel="stylesheet" href="~/css/dashboard.css" />
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
}
@model ASI.Basecode.Services.ServiceModels.ExpenseDataModel

@{
    ViewData["Title"] = "Report";
}
<body>

    <div class="report-header">
        <h1>Expense Summary</h1>
        <div class="mt-2">
            <a href="#" class="report-btn" data-toggle="modal" data-target="#sortByModal">
                Dropdown Report <i class="fa-solid fa-caret-down"></i>
            </a>
        </div>
    </div>

    <div class="report-header2" style="gap: 10px;">
        <button class="header-btn" data-toggle="modal" data-target="#previewModal" onclick="loadPreviewContent()">Preview</button>
        <input type="date" class="header-input" id="dateStart" placeholder="Date Start" style="margin-left: 55%; width: 130px;" />
        <input type="date" class="header-input" id="dateEnd" placeholder="Date End" style="width: 130px;" />
        <button class="header-btn dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">Filter</button>
        <button class="header-btn dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">Sort</button>
    </div>
    <div class="main-content" style="margin-top: 0px; color: #000000; border-radius: 0px; background-color: #FFFFFF;">
        <table class="table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Category</th>
                    <th>Amount</th>
                    <th>Expense Date</th>
                    <th>Description</th>
                </tr>
            </thead>
            <tbody class="data" style="background-color: #FFFFFF; color: #000000;">
                @foreach (var item in Model.ExpenseViewModel)
                {
                    <tr data-toggle="modal" data-target="#expenseDetailModal"
                        data-id="@item.ExpenseId" data-title="@item.Title"
                        data-category="@item.CategoryId" data-amount="@item.Amount"
                        data-date="@item.DateCreated" data-description="@item.Description"
                        class="expense-row">

                        <td>@item.Title</td>
                        <td>@item.CategoryName</td> <!-- Category Name based on CategoryId -->
                        <td>@item.Amount</td>
                        <td>@item.DateCreated</td>
                        <td>@item.Description</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- Modal Structure -->
    <div class="modal fade" id="previewModal" tabindex="-1" role="dialog" aria-labelledby="previewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="previewModalLabel">Expense Summary Preview</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="main-content-preview">
                        <!-- Content will be cloned here by JavaScript -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="generatePDF()" style="background-color: #1A554F; border-radius: 20px;">PDF</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Include jsPDF and html2canvas Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        function loadPreviewContent() {
            const mainContent = document.querySelector('.main-content');
            const modalContent = document.querySelector('.main-content-preview');
            modalContent.innerHTML = '';
            modalContent.innerHTML = mainContent.innerHTML;
        }

        async function generatePDF() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();

            // Capture the content of the modal's body
            const content = document.querySelector('.main-content-preview');

            // Use html2canvas to convert the content to an image
            await html2canvas(content, {
                scale: 2
            }).then((canvas) => {
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 190; // PDF width in mm
                const pageHeight = pdf.internal.pageSize.height;
                const imgHeight = canvas.height * imgWidth / canvas.width;

                // Add the image to the PDF
                pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);

                // Add date and time to the footer
                const currentDate = new Date();
                const footerText = `Generated on: ${currentDate.toLocaleString()}`;
                pdf.setFontSize(10);
                pdf.text(footerText, 10, pageHeight - 10);

                // Save the PDF
                pdf.save('Expense Summary.pdf');
            });
        }
    </script>
</body>
